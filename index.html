<!DOCTYPE html>
<html lang="it">
  <head>
    <meta charset="UTF-8" />
    <title>Cambia password Importy</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      body { font-family: system-ui, -apple-system, sans-serif; padding: 24px; max-width: 480px; margin: auto; }
      .card { border: 1px solid #ddd; border-radius: 8px; padding: 20px; margin-top: 40px; }
      input { width: 100%; padding: 10px; margin-top: 8px; margin-bottom: 16px; }
      button { padding: 10px 16px; cursor: pointer; }
      .error { color: #c00; margin-top: 8px; }
      .success { color: #080; margin-top: 8px; }
    </style>
    <!-- Supabase JS via CDN -->
    <script src="https://unpkg.com/@supabase/supabase-js@2.57.4/dist/umd/supabase.js"></script>
  </head>
  <body>
    <h1>Cambia password Importy</h1>
    <div class="card">
      <p>Imposta una nuova password per il tuo account.</p>
      <form id="password-form">
        <label for="password">Nuova password</label>
        <input id="password" type="password" required minlength="8" />
        <label for="password2">Conferma password</label>
        <input id="password2" type="password" required minlength="8" />
        <button type="submit">Aggiorna password</button>
        <div id="message"></div>
      </form>
    </div>

    <script>
      const SUPABASE_URL = "https://tuo-progetto.supabase.co"; // <-- tue chiavi
      const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."; // <-- tue chiavi
    
      const client = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    
      function getAccessToken() {
        const hash = window.location.hash.substring(1);
        const params = new URLSearchParams(hash);
        return params.get("access_token");
      }
    
      function showMessage(text, isError = false) {
        const el = document.getElementById("message");
        el.textContent = text;
        el.className = isError ? "error" : "success";
      }
    
      document.getElementById("password-form").addEventListener("submit", async (e) => {
        e.preventDefault();
        const password = document.getElementById("password").value;
        const password2 = document.getElementById("password2").value;
    
        if (password !== password2) {
          showMessage("Le password non coincidono.", true);
          return;
        }
    
        try {
          // Per reset password, Supabase si autentica automaticamente dal link
          // Basta chiamare updateUser sull'utente corrente
          const { data, error } = await client.auth.updateUser({ password });
    
          if (error) throw error;
    
          showMessage("âœ… Password aggiornata! Ora fai login in Importy.");
          
          // Pulisci URL
          window.history.replaceState({}, document.title, window.location.pathname);
          
        } catch (err) {
          console.error("Errore completo:", err);
          showMessage(`Errore: ${err.message || "Link non valido"}`, true);
        }
      });
    </script>
  </body>
</html>



<!DOCTYPE html>
<html lang="it">
  <head>
    <meta charset="UTF-8" />
    <title>Cambia password Importy</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      body { font-family: system-ui, -apple-system, sans-serif; padding: 24px; max-width: 480px; margin: auto; }
      .card { border: 1px solid #ddd; border-radius: 8px; padding: 20px; margin-top: 40px; }
      input { width: 100%; padding: 10px; margin-top: 8px; margin-bottom: 16px; }
      button { padding: 10px 16px; cursor: pointer; }
      .error { color: #c00; margin-top: 8px; }
      .success { color: #080; margin-top: 8px; }
    </style>
    <!-- Supabase JS via CDN -->
    <script src="https://unpkg.com/@supabase/supabase-js@2.57.4/dist/umd/supabase.js"></script>
  </head>
  <body>
    <h1>Cambia password Importy</h1>
    <div class="card">
      <p>Imposta una nuova password per il tuo account.</p>
      <form id="password-form">
        <label for="password">Nuova password</label>
        <input id="password" type="password" required minlength="8" />
        <label for="password2">Conferma password</label>
        <input id="password2" type="password" required minlength="8" />
        <button type="submit">Aggiorna password</button>
        <div id="message"></div>
      </form>
    </div>

      <script>
  const SUPABASE_URL = "https://mdavqsnduydurkmdznwh.supabase.co"; 
  const SUPABASE_ANON_KEY = "sb_publishable_FxYIM0vx-3-nI45QWRd5iw_kPzBI6x_";

  const client = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  function getTokensFromHash() {
    const hash = window.location.hash.substring(1);
    console.log("üîç Hash completo:", hash); // DEBUG
    const params = new URLSearchParams(hash);
    const tokens = {
      access_token: params.get("access_token"),
      refresh_token: params.get("refresh_token") || "",
      type: params.get("type") || ""
    };
    console.log("üîç Token estratti:", tokens); // DEBUG
    return tokens;
  }

  function showMessage(text, isError = false) {
    const el = document.getElementById("message");
    el.textContent = text;
    el.className = isError ? "error" : "success";
  }

  document.getElementById("password-form").addEventListener("submit", async (e) => {
    e.preventDefault();
    const password = document.getElementById("password").value;
    const password2 = document.getElementById("password2").value;

    if (password !== password2) {
      showMessage("Le password non coincidono.", true);
      return;
    }

    try {
      const { access_token, refresh_token, type } = getTokensFromHash();
      
      if (!access_token) {
        throw new Error("Nessun access_token nel link");
      }

      console.log("üîÑ Tentativo setSession..."); // DEBUG
      
      const { error: sessionError } = await client.auth.setSession({
        access_token,
        refresh_token
      });

      if (sessionError) {
        console.error("‚ùå setSession error:", sessionError);
        throw new Error(`setSession fallito: ${sessionError.message}`);
      }

      console.log("‚úÖ setSession OK, update password..."); // DEBUG
      
      const { error } = await client.auth.updateUser({ password });
      
      if (error) {
        console.error("‚ùå updateUser error:", error);
        throw error;
      }

      showMessage("‚úÖ Password aggiornata!");
      window.history.replaceState({}, document.title, window.location.pathname);
      
    } catch (err) {
      console.error("üí• Errore completo:", err);
      showMessage(`Errore: ${err.message}`, true);
    }
  });
</script>
  </body>
</html>






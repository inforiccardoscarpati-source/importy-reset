<!DOCTYPE html>
<html lang="it">
  <head>
    <meta charset="UTF-8" />
    <title>Cambia password Importy</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      body { font-family: system-ui, -apple-system, sans-serif; padding: 24px; max-width: 480px; margin: auto; }
      .card { border: 1px solid #ddd; border-radius: 8px; padding: 20px; margin-top: 40px; }
      input { width: 100%; padding: 10px; margin-top: 8px; margin-bottom: 16px; }
      button { padding: 10px 16px; cursor: pointer; }
      .error { color: #c00; margin-top: 8px; }
      .success { color: #080; margin-top: 8px; }
    </style>
    <!-- Supabase JS via CDN -->
    <script src="https://unpkg.com/@supabase/supabase-js@2.57.4/dist/umd/supabase.js"></script>
  </head>
  <body>
    <h1>Cambia password Importy</h1>
    <div class="card">
      <p>Imposta una nuova password per il tuo account.</p>
      <form id="password-form">
        <label for="password">Nuova password</label>
        <input id="password" type="password" required minlength="8" />
        <label for="password2">Conferma password</label>
        <input id="password2" type="password" required minlength="8" />
        <button type="submit">Aggiorna password</button>
        <div id="message"></div>
      </form>
    </div>

      <script>
  const SUPABASE_URL = "https://mdavqsnduydurkmdznwh.supabase.co"; // tuo PROJECT_URL
  const SUPABASE_ANON_KEY = "sb_publishable_FxYIM0vx-3-nI45QWRd5iw_kPzBI6x_";                  // da Settings → API

  const client = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  function showMessage(text, isError = false) {
    const el = document.getElementById("message");
    if (!el) return;
    el.textContent = text;
    el.className = isError ? "error" : "success";
  }

  async function verifyLinkAndMaybeShowForm() {
    const params = new URLSearchParams(window.location.search);
    const token_hash = params.get("token_hash");

    const stepVerify = document.getElementById("step-verify");
    const form = document.getElementById("password-form");

    // Se non c'è token_hash, non siamo arrivati da email di reset
    if (!token_hash) {
      if (stepVerify) stepVerify.textContent = "Nessun link di reset rilevato.";
      return;
    }

    if (stepVerify) stepVerify.textContent = "Verifica del link in corso...";

    // 1) Verifica token di recovery
    const { error } = await client.auth.verifyOtp({
      type: "email",
      token_hash,
    });

    if (error) {
      console.error("verifyOtp error", error);
      if (stepVerify) stepVerify.textContent = "Link non valido o scaduto.";
      return;
    }

    // 2) Se ok, mostra il form password
    if (stepVerify) stepVerify.style.display = "none";
    if (form) form.style.display = "block";
  }

  async function handlePasswordSubmit(e) {
    e.preventDefault();
    const pw1 = document.getElementById("password").value;
    const pw2 = document.getElementById("password2").value;

    if (pw1 !== pw2) {
      showMessage("Le password non coincidono.", true);
      return;
    }

    // 3) Cambia password per l'utente autenticato da verifyOtp
    const { error } = await client.auth.updateUser({ password: pw1 });

    if (error) {
      console.error("updateUser error", error);
      showMessage("Errore durante l'aggiornamento della password.", true);
      return;
    }

    showMessage("Password aggiornata con successo! Ora puoi usare Importy.");
    // opzionale: pulisci la query
    window.history.replaceState({}, document.title, window.location.pathname);
  }

  // Hook iniziali
  window.addEventListener("DOMContentLoaded", () => {
    const form = document.getElementById("password-form");
    if (form) form.addEventListener("submit", handlePasswordSubmit);
    verifyLinkAndMaybeShowForm();
  });
</script>
  </body>
</html>







